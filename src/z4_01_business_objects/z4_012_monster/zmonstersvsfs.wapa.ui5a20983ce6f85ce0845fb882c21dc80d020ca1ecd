// Simple typographic replacements                                                                                                                                                                                                                             
//                                                                                                                                                                                                                                                             
// (c) (C) â†’ Â©                                                                                                                                                                                                                                              
// (tm) (TM) â†’ â„¢                                                                                                                                                                                                                                           
// (r) (R) â†’ Â®                                                                                                                                                                                                                                              
// +- â†’ Â±                                                                                                                                                                                                                                                   
// (p) (P) -> Â§                                                                                                                                                                                                                                               
// ... â†’ â€¦ (also ?.... â†’ ?.., !.... â†’ !..)                                                                                                                                                                                                             
// ???????? â†’ ???, !!!!! â†’ !!!, `,,` â†’ `,`                                                                                                                                                                                                               
// -- â†’ &ndash;, --- â†’ &mdash;                                                                                                                                                                                                                             
//                                                                                                                                                                                                                                                             
'use strict';                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
// TODO:                                                                                                                                                                                                                                                       
// - fractionals 1/2, 1/4, 3/4 -> Â½, Â¼, Â¾                                                                                                                                                                                                                   
// - miltiplication 2 x 4 -> 2 Ã— 4                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
var RARE_RE = /\+-|\.\.|\?\?\?\?|!!!!|,,|--/;                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
// Workaround for phantomjs - need regex without /g flag,                                                                                                                                                                                                      
// or root check will fail every second time                                                                                                                                                                                                                   
var SCOPED_ABBR_TEST_RE = /\((c|tm|r|p)\)/i;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
var SCOPED_ABBR_RE = /\((c|tm|r|p)\)/ig;                                                                                                                                                                                                                       
var SCOPED_ABBR = {                                                                                                                                                                                                                                            
  c: 'Â©',                                                                                                                                                                                                                                                     
  r: 'Â®',                                                                                                                                                                                                                                                     
  p: 'Â§',                                                                                                                                                                                                                                                     
  tm: 'â„¢'                                                                                                                                                                                                                                                    
};                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
function replaceFn(match, name) {                                                                                                                                                                                                                              
  return SCOPED_ABBR[name.toLowerCase()];                                                                                                                                                                                                                      
}                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
function replace_scoped(inlineTokens) {                                                                                                                                                                                                                        
  var i, token, inside_autolink = 0;                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
  for (i = inlineTokens.length - 1; i >= 0; i--) {                                                                                                                                                                                                             
    token = inlineTokens[i];                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
    if (token.type === 'text' && !inside_autolink) {                                                                                                                                                                                                           
      token.content = token.content.replace(SCOPED_ABBR_RE, replaceFn);                                                                                                                                                                                        
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    if (token.type === 'link_open' && token.info === 'auto') {                                                                                                                                                                                                 
      inside_autolink--;                                                                                                                                                                                                                                       
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    if (token.type === 'link_close' && token.info === 'auto') {                                                                                                                                                                                                
      inside_autolink++;                                                                                                                                                                                                                                       
    }                                                                                                                                                                                                                                                          
  }                                                                                                                                                                                                                                                            
}                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
function replace_rare(inlineTokens) {                                                                                                                                                                                                                          
  var i, token, inside_autolink = 0;                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
  for (i = inlineTokens.length - 1; i >= 0; i--) {                                                                                                                                                                                                             
    token = inlineTokens[i];                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
    if (token.type === 'text' && !inside_autolink) {                                                                                                                                                                                                           
      if (RARE_RE.test(token.content)) {                                                                                                                                                                                                                       
        token.content = token.content                                                                                                                                                                                                                          
          .replace(/\+-/g, 'Â±')                                                                                                                                                                                                                               
          // .., ..., ....... -> â€¦                                                                                                                                                                                                                           
          // but ?..... & !..... -> ?.. & !..                                                                                                                                                                                                                  
          .replace(/\.{2,}/g, 'â€¦').replace(/([?!])â€¦/g, '$1..')                                                                                                                                                                                             
          .replace(/([?!]){4,}/g, '$1$1$1').replace(/,{2,}/g, ',')                                                                                                                                                                                             
          // em-dash                                                                                                                                                                                                                                           
          .replace(/(^|[^-])---([^-]|$)/mg, '$1\u2014$2')                                                                                                                                                                                                      
          // en-dash                                                                                                                                                                                                                                           
          .replace(/(^|\s)--(\s|$)/mg, '$1\u2013$2')                                                                                                                                                                                                           
          .replace(/(^|[^-\s])--([^-\s]|$)/mg, '$1\u2013$2');                                                                                                                                                                                                  
      }                                                                                                                                                                                                                                                        
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    if (token.type === 'link_open' && token.info === 'auto') {                                                                                                                                                                                                 
      inside_autolink--;                                                                                                                                                                                                                                       
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    if (token.type === 'link_close' && token.info === 'auto') {                                                                                                                                                                                                
      inside_autolink++;                                                                                                                                                                                                                                       
    }                                                                                                                                                                                                                                                          
  }                                                                                                                                                                                                                                                            
}                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
module.exports = function replace(state) {                                                                                                                                                                                                                     
  var blkIdx;                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
  if (!state.md.options.typographer) { return; }                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
  for (blkIdx = state.tokens.length - 1; blkIdx >= 0; blkIdx--) {                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    if (state.tokens[blkIdx].type !== 'inline') { continue; }                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
    if (SCOPED_ABBR_TEST_RE.test(state.tokens[blkIdx].content)) {                                                                                                                                                                                              
      replace_scoped(state.tokens[blkIdx].children);                                                                                                                                                                                                           
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    if (RARE_RE.test(state.tokens[blkIdx].content)) {                                                                                                                                                                                                          
      replace_rare(state.tokens[blkIdx].children);                                                                                                                                                                                                             
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
  }                                                                                                                                                                                                                                                            
};                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               